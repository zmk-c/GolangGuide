# Goè¯­è¨€æ·±åº¦è§£æä¹‹unsafe

## 1.ä»€ä¹ˆæ˜¯unsafe

unsafe åº“è®© golang å¯ä»¥åƒCè¯­è¨€ä¸€æ ·æ“ä½œè®¡ç®—æœºå†…å­˜ï¼Œä½†è¿™å¹¶ä¸æ˜¯golangæ¨èä½¿ç”¨çš„ï¼Œèƒ½ä¸ç”¨å°½é‡ä¸ç”¨ï¼Œå°±åƒå®ƒçš„åå­—æ‰€è¡¨è¾¾çš„ä¸€æ ·ï¼Œå®ƒç»•è¿‡äº†golangçš„å†…å­˜å®‰å…¨åŸåˆ™ï¼Œæ˜¯ä¸å®‰å…¨çš„ï¼Œå®¹æ˜“ä½¿ä½ çš„ç¨‹åºå‡ºç°è«åå…¶å¦™çš„é—®é¢˜ï¼Œä¸åˆ©äºç¨‹åºçš„æ‰©å±•ä¸ç»´æŠ¤ã€‚

å…ˆç®€å•ä»‹ç»ä¸‹GolangæŒ‡é’ˆç±»å‹ï¼š

1. `*ç±»å‹`ï¼šæ™®é€šæŒ‡é’ˆï¼Œç”¨äºä¼ é€’å¯¹è±¡åœ°å€ï¼Œä¸èƒ½è¿›è¡ŒæŒ‡é’ˆè¿ç®—ã€‚
2. `unsafe.Pointer`ï¼šé€šç”¨æŒ‡é’ˆç±»å‹ï¼Œç”¨äºè½¬æ¢ä¸åŒç±»å‹çš„æŒ‡é’ˆï¼Œä¸èƒ½è¿›è¡ŒæŒ‡é’ˆè¿ç®—ã€‚
3. `uintptr`ï¼šç”¨äºæŒ‡é’ˆè¿ç®—ï¼ŒGC ä¸æŠŠ uintptr å½“æŒ‡é’ˆï¼Œuintptr æ— æ³•æŒæœ‰å¯¹è±¡ï¼Œ**uintptr ç±»å‹çš„ç›®æ ‡ä¼šè¢«å›æ”¶**ã€‚

unsafe.Pointer å¯ä»¥å’Œ æ™®é€šæŒ‡é’ˆ è¿›è¡Œç›¸äº’è½¬æ¢ã€‚

unsafe.Pointer å¯ä»¥å’Œ uintptr è¿›è¡Œç›¸äº’è½¬æ¢ã€‚

ä¹Ÿå°±æ˜¯è¯´ **unsafe.Pointer æ˜¯æ¡¥æ¢ï¼Œå¯ä»¥è®©ä»»æ„ç±»å‹çš„æŒ‡é’ˆå®ç°ç›¸äº’è½¬æ¢ï¼Œä¹Ÿå¯ä»¥å°†ä»»æ„ç±»å‹çš„æŒ‡é’ˆè½¬æ¢ä¸º uintptr è¿›è¡ŒæŒ‡é’ˆè¿**ç®—ã€‚

![å›¾ç‰‡](https://raw.githubusercontent.com/zmk-c/blogImages/master/img/transf.png)

unsafeåº•å±‚æºç å¦‚ä¸‹ï¼š

ä¸¤ä¸ªç±»å‹ï¼š

```go
// go 1.14 src/unsafe/unsafe.go
type ArbitraryType int
type Pointer *ArbitraryType
```

**ArbitraryType**æ˜¯intçš„ä¸€ä¸ªåˆ«åï¼Œåœ¨Goä¸­å¯¹ArbitraryTypeèµ‹äºˆç‰¹æ®Šçš„æ„ä¹‰ã€‚ä»£è¡¨ä¸€ä¸ªä»»æ„Goè¡¨è¾¾å¼ç±»å‹ã€‚

**Pointer** æ˜¯ intæŒ‡é’ˆç±»å‹ çš„ä¸€ä¸ªåˆ«åï¼Œåœ¨Goä¸­å¯ä»¥æŠŠPointerç±»å‹ï¼Œç†è§£æˆä»»ä½•æŒ‡é’ˆçš„çˆ¶ç±»å‹ã€‚

ä¸‰ä¸ªå‡½æ•°ï¼š

```go
func Sizeof(x ArbitraryType) uintptr
func Offsetof(x ArbitraryType) uintptr
func Alignof(x ArbitraryType) uintptr
```

é€šè¿‡åˆ†æå‘ç°ï¼Œè¿™ä¸‰ä¸ªå‡½æ•°çš„å‚æ•°å‡æ˜¯ArbitraryTypeç±»å‹ï¼Œå°±æ˜¯æ¥å—ä»»ä½•ç±»å‹çš„å˜é‡ã€‚

1. `Sizeof` **è¿”å›ç±»å‹ x æ‰€å æ®çš„å­—èŠ‚æ•°ï¼Œä½†ä¸åŒ…å« x æ‰€æŒ‡å‘çš„å†…å®¹çš„å¤§å°**ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªæŒ‡é’ˆï¼Œå‡½æ•°è¿”å›çš„å¤§å°ä¸º 8 å­—èŠ‚ï¼ˆ64ä½æœºä¸Šï¼‰ï¼Œä¸€ä¸ª slice çš„å¤§å°åˆ™ä¸º slice header çš„å¤§å°ã€‚
2. `Offsetof`è¿”å›å˜é‡æŒ‡å®šå±æ€§çš„åç§»é‡ï¼Œè¿™ä¸ªå‡½æ•°è™½ç„¶æ¥æ”¶çš„æ˜¯ä»»ä½•ç±»å‹çš„å˜é‡ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå‰æï¼Œå°±æ˜¯å˜é‡è¦æ˜¯ä¸€ä¸ªstructç±»å‹ï¼Œä¸”è¿˜ä¸èƒ½ç›´æ¥å°†è¿™ä¸ªstructç±»å‹çš„å˜é‡å½“ä½œå‚æ•°ï¼Œåªèƒ½å°†è¿™ä¸ªstructç±»å‹å˜é‡çš„å±æ€§å½“ä½œå‚æ•°ã€‚
3. `Alignof`è¿”å›å˜é‡å¯¹é½å­—èŠ‚æ•°é‡

## 2.unsafeåŒ…çš„æ“ä½œ

### 2.1å¤§å°Sizeof

unsafe.Sizeofå‡½æ•°è¿”å›çš„å°±æ˜¯uintptrç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºæ‰€å æ®çš„å­—èŠ‚æ•°ï¼ˆè¡¨è¾¾å¼ï¼Œå³å€¼çš„å¤§å°ï¼‰ï¼š

```go
package main

import (
	"fmt"
	"reflect"
	"unsafe"
)

func main() {
	var a int32
	var b = &a
	fmt.Println(reflect.TypeOf(unsafe.Sizeof(a))) // uintptr
	fmt.Println(unsafe.Sizeof(a))                 // 4
	fmt.Println(reflect.TypeOf(b).Kind()) // ptr
	fmt.Println(unsafe.Sizeof(b)) // 8
}
```

å¯¹äº `a`æ¥è¯´ï¼Œå®ƒæ˜¯`int32`ç±»å‹ï¼Œåœ¨å†…å­˜ä¸­å 4ä¸ªå­—èŠ‚ï¼Œè€Œå¯¹äº`b`æ¥è¯´ï¼Œæ˜¯`*int32`ç±»å‹ï¼Œå³åº•å±‚ä¸º`ptr`æŒ‡é’ˆç±»å‹ï¼Œåœ¨64ä½æœºä¸‹å 8å­—èŠ‚ã€‚

### 2.2åç§»Offsetof

å¯¹äºä¸€ä¸ªç»“æ„ä½“ï¼Œé€šè¿‡ Offset å‡½æ•°å¯ä»¥è·å–ç»“æ„ä½“æˆå‘˜çš„åç§»é‡ï¼Œè¿›è€Œè·å–æˆå‘˜çš„åœ°å€ï¼Œè¯»å†™è¯¥åœ°å€çš„å†…å­˜ï¼Œå°±å¯ä»¥è¾¾åˆ°æ”¹å˜æˆå‘˜å€¼çš„ç›®çš„ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå†…å­˜åˆ†é…ç›¸å…³çš„äº‹å®ï¼š**ç»“æ„ä½“ä¼šè¢«åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œç»“æ„ä½“çš„åœ°å€ä¹Ÿä»£è¡¨äº†ç¬¬ä¸€ä¸ªå­—æ®µçš„åœ°å€ã€‚**

ä¸¾ä¸ªä¾‹å­ï¼š

```go
package main

import (
	"fmt"
	"unsafe"
)

type user struct {
	id   int32
	name string
	age  byte
}

func main() {
	var u = user{
		id:   1,
		name: "xiaobai",
		age:  22,
	}
	fmt.Println(u)
	fmt.Println(unsafe.Offsetof(u.id))   // 0  idåœ¨ç»“æ„ä½“userä¸­çš„åç§»é‡,ä¹Ÿæ˜¯ç»“æ„ä½“çš„åœ°å€
	fmt.Println(unsafe.Offsetof(u.name)) // 8
	fmt.Println(unsafe.Offsetof(u.age))  // 24

	// æ ¹æ®åç§»é‡ä¿®æ”¹å­—æ®µçš„å€¼ æ¯”å¦‚å°†idå­—æ®µæ”¹ä¸º1001
	// å› ä¸ºç»“æ„ä½“çš„åœ°å€ç›¸å½“äºç¬¬ä¸€ä¸ªå­—æ®µidçš„åœ°å€
	// ç›´æ¥ç”¨unsafeåŒ…è‡ªå¸¦çš„Pointerè·å–idæŒ‡é’ˆ
	id := (*int)(unsafe.Pointer(&u))
	*id = 1001

	// æ›´åŠ ç›¸å¯¹äºidå­—æ®µçš„åç§»é‡è·å–nameå­—æ®µçš„åœ°å€å¹¶ä¿®æ”¹å…¶å†…å®¹
	// éœ€è¦ç”¨åˆ°uintptrè¿›è¡ŒæŒ‡é’ˆè¿ç®— ç„¶åå†åˆ©ç”¨unsafe.Pointerè¿™ä¸ªåª’ä»‹å°†uintptrç±»å‹è½¬æ¢æˆä¸€èˆ¬çš„æŒ‡é’ˆç±»å‹*string
	name := (*string)(unsafe.Pointer(uintptr(unsafe.Pointer(&u)) + unsafe.Offsetof(u.name)))
	*name = "èŠ±èŠ±"

	// åŒç†æ›´æ”¹ageå­—æ®µ
	age := (*int)(unsafe.Pointer(uintptr(unsafe.Pointer(&u)) + unsafe.Offsetof(u.age)))
	*age = 33

	fmt.Println(u)
}
```

### 2.3å¯¹é½Alignof

è¦äº†è§£è¿™ä¸ªå‡½æ•°ï¼Œä½ éœ€è¦äº†è§£`æ•°æ®å¯¹é½`ã€‚ç®€å•çš„è¯´ï¼Œå®ƒè®©æ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­ä»¥æŸç§çš„å¸ƒå±€å­˜æ”¾ï¼Œæ˜¯è¯¥æ•°æ®çš„è¯»å–æ€§èƒ½èƒ½å¤Ÿæ›´åŠ çš„å¿«é€Ÿã€‚

CPU è¯»å–å†…å­˜æ˜¯ä¸€å—ä¸€å—è¯»å–çš„ï¼Œå—çš„å¤§å°å¯ä»¥ä¸º 2ã€4ã€6ã€8ã€16 å­—èŠ‚ç­‰å¤§å°ã€‚å—å¤§å°æˆ‘ä»¬ç§°å…¶ä¸ºå†…å­˜è®¿é—®ç²’åº¦ã€‚

#### æ™®é€šå­—æ®µçš„å¯¹é½å€¼

```go
fmt.Printf("bool align: %d\n", unsafe.Alignof(bool(true)))
fmt.Printf("int32 align: %d\n", unsafe.Alignof(int32(0)))
fmt.Printf("int8 align: %d\n", unsafe.Alignof(int8(0)))
fmt.Printf("int64 align: %d\n", unsafe.Alignof(int64(0)))
fmt.Printf("byte align: %d\n", unsafe.Alignof(byte(0)))
fmt.Printf("string align: %d\n", unsafe.Alignof("EDDYCJY"))
fmt.Printf("map align: %d\n", unsafe.Alignof(map[string]string{}))
```

è¾“å‡ºç»“æœï¼š

```text
bool align: 1
int32 align: 4
int8 align: 1
int64 align: 8
byte align: 1
string align: 8
map align: 8
```

åœ¨ Go ä¸­å¯ä»¥è°ƒç”¨ `unsafe.Alignof` æ¥è¿”å›ç›¸åº”ç±»å‹çš„å¯¹é½ç³»æ•°ã€‚é€šè¿‡è§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå¯å¾—çŸ¥åŸºæœ¬éƒ½æ˜¯ 2<sup>n</sup>ï¼Œæœ€å¤§ä¹Ÿ`ä¸ä¼šè¶…è¿‡ 8`ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„64ä½ç¼–è¯‘å™¨é»˜è®¤å¯¹é½ç³»æ•°æ˜¯ 8ï¼Œå› æ­¤æœ€å¤§å€¼ä¸ä¼šè¶…è¿‡è¿™ä¸ªæ•°ã€‚

#### å¯¹é½è§„åˆ™

1. **ç»“æ„ä½“çš„æˆå‘˜å˜é‡**ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡çš„åç§»é‡ä¸º 0ã€‚å¾€åçš„æ¯ä¸ªæˆå‘˜å˜é‡çš„å¯¹é½å€¼å¿…é¡»ä¸º**ç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦**ï¼ˆ`#pragma pack(n)`ï¼‰æˆ–**å½“å‰æˆå‘˜å˜é‡ç±»å‹çš„é•¿åº¦**ï¼ˆ`unsafe.Sizeof`ï¼‰ï¼Œ**å–æœ€å°å€¼**ä½œä¸ºå½“å‰ç±»å‹çš„å¯¹é½å€¼ã€‚å…¶**åç§»é‡å¿…é¡»ä¸ºå¯¹é½å€¼çš„æ•´æ•°å€**
2. **ç»“æ„ä½“æœ¬èº«**ï¼Œå¯¹é½å€¼å¿…é¡»ä¸º**ç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦**æˆ–**ç»“æ„ä½“çš„æ‰€æœ‰æˆå‘˜å˜é‡ç±»å‹ä¸­çš„æœ€å¤§é•¿åº¦**ï¼Œ**å–æœ€å¤§æ•°çš„æœ€å°æ•´æ•°å€**ä½œä¸ºå¯¹é½å€¼

ç»“åˆä»¥ä¸Šä¸¤ç‚¹ï¼Œå¯å¾—çŸ¥è‹¥ç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦è¶…è¿‡ç»“æ„ä½“å†…æˆå‘˜å˜é‡çš„ç±»å‹æœ€å¤§é•¿åº¦æ—¶ï¼Œé»˜è®¤å¯¹é½é•¿åº¦æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„

#### ç»“æ„ä½“çš„å¯¹é½å€¼

ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ç»“æ„ä½“çš„å¯¹é½ï¼š

```go
type part struct {
	a bool  // 1
	b int32 //4
	c int8  // 1
	d int64 // 8
	e byte  // 1
}

func main() {
	var p part
	fmt.Println(unsafe.Sizeof(p)) // 32
}
```

æŒ‰ç…§æ™®é€šå­—æ®µï¼ˆç»“æ„ä½“å†…æˆå‘˜å˜é‡ï¼‰çš„å¯¹é½æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å¾—å‡ºï¼Œè¿™ä¸ªç»“æ„ä½“çš„å¤§å°å `1+4+1+8+1=15`ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ç”¨`unsafe.Sizeof`è®¡ç®—å‘ç°`partç»“æ„ä½“`å `32`å­—èŠ‚ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹æƒŠè®¶ğŸ˜®

è¿™é‡Œé¢å°±æ¶‰åŠåˆ°äº†å†…å­˜å¯¹é½ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š

| æˆå‘˜å˜é‡   | ç±»å‹  | åç§»é‡ | è‡ªèº«å ç”¨ |
| ---------- | ----- | ------ | -------- |
| a          | bool  | 0      | 1        |
| æ•°æ®å¯¹é½   | -     | 1      | 3        |
| b          | int32 | 4      | 4        |
| c          | int8  | 8      | 1        |
| æ•°æ®å¯¹é½   | -     | 9      | 7        |
| d          | in64  | 16     | 8        |
| e          | byte  | 24     | 1        |
| æ•°æ®å¯¹é½   | -     | 25     | 7        |
| æ€»å ç”¨å¤§å° | -     | -      | 32       |

- å¯¹äºå˜é‡aè€Œè¨€

  ç±»å‹æ˜¯boolï¼›å¤§å°/å¯¹é½å€¼æœ¬èº«ä¸º1å­—èŠ‚ï¼›åç§»é‡ä¸º0ï¼Œ**å ç”¨äº†ç¬¬0ä½**ï¼›æ­¤æ—¶å†…å­˜ä¸­è¡¨ç¤ºä¸º`a`

- å¯¹äºå˜é‡bè€Œè¨€

  ç±»å‹æ˜¯int32ï¼›å¤§å°/å¯¹é½å€¼æœ¬èº«ä¸º4å­—èŠ‚ï¼›æ ¹æ®å¯¹é½è§„åˆ™ä¸€ï¼Œåç§»é‡å¿…é¡»ä¸ºå¯¹é½å€¼4çš„æ•´æ•°å€ï¼Œæ•…è¿™é‡Œçš„åç§»é‡ä¸º4ï¼Œ**å ç”¨äº†ç¬¬4~7ä½**ï¼Œåˆ™**ç¬¬1~3ä½ç”¨paddingå­—èŠ‚å¡«å……**ï¼›æ­¤æ—¶å†…å­˜ä¸­è¡¨ç¤ºä¸º`a---|bbbb`ï¼Œ(`|`åªèµ·åˆ°åˆ†éš”ä½œç”¨ï¼Œè¡¨ç¤ºæ–¹ä¾¿ä¸€äº›)

- å¯¹äºå˜é‡cè€Œè¨€

  ç±»å‹æ˜¯int8ï¼›å¤§å°/å¯¹é½å€¼æœ¬èº«ä¸º1å­—èŠ‚ï¼›å½“å‰åç§»é‡ä¸º8ï¼Œæ— éœ€æ‰©å……ï¼Œ**å ç”¨äº†ç¬¬8ä½**ï¼›æ­¤æ—¶å†…å­˜ä¸­è¡¨ç¤ºä¸º`a---|bbbb|c`

- å¯¹äºå˜é‡dè€Œè¨€

  ç±»å‹æ˜¯int64ï¼›å¤§å°/å¯¹é½å€¼æœ¬èº«ä¸º8å­—èŠ‚ï¼›æ ¹æ®å¯¹é½è§„åˆ™ä¸€ï¼Œåç§»é‡å¿…é¡»ä¸ºå¯¹é½å€¼8çš„æ•´æ•°å€ï¼Œæ•…è¿™ç†çš„åç§»é‡ä¸º16ï¼Œ**å ç”¨äº†ç¬¬16~23ä½**ï¼Œåˆ™**ç¬¬9~15ä¸ºç”¨paddingå­—èŠ‚å¡«å……**ï¼›æ­¤æ—¶å†…å­˜ä¸­è¡¨ç¤ºä¸º`a---|bbbb|c---|----`

- å¯¹äºå˜é‡eè€Œè¨€

  ç±»å‹æ˜¯byteï¼›å¤§å°/å¯¹é½å€¼æœ¬èº«ä¸º1å­—èŠ‚ï¼›å½“å‰åç§»é‡ä¸º24ï¼Œæ— éœ€æ‰©å……ï¼Œ**å ç”¨äº†ç¬¬24ä½**ï¼›æ­¤æ—¶å†…å­˜ä¸­è¡¨ç¤ºä¸º`a---|bbbb|c---|----|e`

è¿™é‡Œè®¡ç®—åï¼Œå‘ç°æ€»å…±å ç”¨25å­—èŠ‚ï¼Œå“ªé‡Œåˆæ¥çš„32å­—èŠ‚å‘¢ï¼ŸğŸ˜³ `:flushed:`

å†è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å¯¹é½åŸåˆ™çš„ç¬¬äºŒç‚¹ï¼Œ**â€œç»“æ„ä½“æœ¬èº«ï¼Œå¯¹é½å€¼å¿…é¡»ä¸ºç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦æˆ–ç»“æ„ä½“çš„æ‰€æœ‰æˆå‘˜å˜é‡ç±»å‹ä¸­çš„æœ€å¤§é•¿åº¦ï¼Œå–æœ€å¤§æ•°çš„æœ€å°æ•´æ•°å€ä½œä¸ºå¯¹é½å€¼â€**

1. è¿™é‡Œç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦ä¸º8å­—èŠ‚(64ä½æœº)

2. ç»“æ„ä½“ä¸­æ‰€æœ‰æˆå‘˜å˜é‡ç±»å‹çš„æœ€å¤§é•¿åº¦ä¸ºint64ï¼Œ8å­—èŠ‚
3. å–äºŒè€…æœ€å¤§æ•°çš„æœ€å°æ•´æ•°å€ä½œä¸ºå¯¹é½å€¼ï¼Œæˆ‘ä»¬ç®—çš„partç»“æ„ä½“å¤§å°ä¸º25å­—èŠ‚ï¼Œä¸æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œæ•…è¿˜éœ€è¦å¡«å……åˆ°32å­—èŠ‚ã€‚

ç»¼ä¸Šï¼Œpartç»“æ„ä½“åœ¨å†…å­˜ä¸­è¡¨ç¤ºä¸º`a---|bbbb|c---|----|e----|----`

#### æ‰©å±•

è®©æˆ‘ä»¬æ”¹å˜ä¸€ä¸‹partç»“æ„ä½“ä¸­å­—æ®µçš„é¡ºåºçœ‹çœ‹ï¼ˆpartç»“æ„ä½“å®Œå…¨ç›¸åŒï¼‰

```go
type part struct {
	a bool  // 1
	c int8  // 1
	e byte  // 1
	b int32 //4
	d int64 // 8
}

func main() {
	var p part
	fmt.Println(unsafe.Sizeof(p)) // 16
}
```

è¿™æ—¶å€™å†ç”¨`unsafe.Sizeof`æŸ¥çœ‹ä¼šå‘ç°ï¼Œpartç»“æ„ä½“çš„å†…å­˜å ç”¨åªæœ‰`16`å­—èŠ‚ï¼Œç¬é—´å‡å°‘äº†ä¸€èˆ¬çš„å†…å­˜ç©ºé—´ï¼Œå¤§å®¶å¯ä»¥æŒ‰ç…§å‰é¢çš„æ­¥éª¤åˆ†æä¸€ä¸‹~

è¿™é‡Œå»ºè®®åœ¨æ„å»ºç»“æ„ä½“æ—¶ï¼ŒæŒ‰ç…§å­—æ®µå¤§å°çš„å‡åºè¿›è¡Œæ’åºï¼Œä¼šå‡å°‘ä¸€ç‚¹çš„å†…å­˜ç©ºé—´ã€‚

#### åå°„åŒ…çš„å¯¹é½æ–¹æ³•

åå°„åŒ…ä¹Ÿæœ‰æŸäº›æ–¹æ³•å¯ç”¨äºè®¡ç®—å¯¹é½å€¼ï¼š

```go
unsafe.Alignof(w)ç­‰ä»·äºreflect.TypeOf(w).Align
unsafe.Alignof(w.i)ç­‰ä»·äºreflect.Typeof(w.i).FieldAlign()
```

## æ€»ç»“

- unsafe åŒ…ç»•è¿‡äº† Go çš„ç±»å‹ç³»ç»Ÿï¼Œè¾¾åˆ°ç›´æ¥æ“ä½œå†…å­˜çš„ç›®çš„ï¼Œä½¿ç”¨å®ƒæœ‰ä¸€å®šçš„é£é™©æ€§ã€‚ä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ unsafe åŒ…æä¾›çš„å‡½æ•°ä¼šæå‡ä»£ç çš„æ•ˆç‡ï¼ŒGo æºç ä¸­ä¹Ÿæ˜¯å¤§é‡ä½¿ç”¨ unsafe åŒ…ã€‚

- unsafe åŒ…å®šä¹‰äº† Pointer å’Œä¸‰ä¸ªå‡½æ•°ï¼š

  ```go
  type ArbitraryType int
  type Pointer *ArbitraryType
  func Sizeof(x ArbitraryType) uintptr
  func Offsetof(x ArbitraryType) uintptr
  func Alignof(x ArbitraryType) uintptr
  ```

  é€šè¿‡ä¸‰ä¸ªå‡½æ•°å¯ä»¥è·å–å˜é‡çš„å¤§å°ã€åç§»ã€å¯¹é½ç­‰ä¿¡æ¯ã€‚

- uintptr å¯ä»¥å’Œ unsafe.Pointer è¿›è¡Œç›¸äº’è½¬æ¢ï¼Œuintptr å¯ä»¥è¿›è¡Œæ•°å­¦è¿ç®—ã€‚è¿™æ ·ï¼Œé€šè¿‡ uintptr å’Œ unsafe.Pointer çš„ç»“åˆå°±è§£å†³äº† Go æŒ‡é’ˆä¸èƒ½è¿›è¡Œæ•°å­¦è¿ç®—çš„é™åˆ¶ã€‚

- é€šè¿‡ unsafe ç›¸å…³å‡½æ•°ï¼Œå¯ä»¥è·å–ç»“æ„ä½“ç§æœ‰æˆå‘˜çš„åœ°å€ï¼Œè¿›è€Œå¯¹å…¶åšè¿›ä¸€æ­¥çš„è¯»å†™æ“ä½œï¼Œçªç ´ Go çš„ç±»å‹å®‰å…¨é™åˆ¶ã€‚

  

> å‚è€ƒï¼š
>
> - [æ·±åº¦è§£å¯†Goè¯­è¨€ä¹‹unsafe](https://mp.weixin.qq.com/s/OO-kwB4Fp_FnCaNXwGJoEw)
> - [unsafeåŒ…çš„å­¦ä¹ å’Œä½¿ç”¨ - ç¦»åœ°æœ€è¿œçš„æ˜Ÿ - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/hualou/p/12070155.html)
> - [åœ¨ Go ä¸­æ°åˆ°å¥½å¤„çš„å†…å­˜å¯¹é½ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/53413177)